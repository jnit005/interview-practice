<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Insmot AI Interview Coach</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéôÔ∏è</text></svg>">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      /* Color variables */
      --primary-600: #4F46E5;
      --primary-500: #6366F1;
      --primary-100: #EEF2FF;
      --primary-50: #FAFAFF;

      --secondary-600: #10B981;
      --secondary-100: #D1FAE5;
      
      --danger-500: #EF4444;
      --danger-100: #FEE2E2;

      --text-900: #111827;
      --text-500: #6B7280;
      --border: #E5E7EB;
      --bg: #F9FAFB;
      
      /* Global styles */
      font-family: 'Inter', sans-serif;
      font-synthesis: none;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      /* NEW: Subtle gradient background */
      background: linear-gradient(170deg, var(--bg) 0%, #ffffff 100%);
      color: var(--text-900);
      margin: 0;
      padding: 40px 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      box-sizing: border-box;
    }

    /* --- NEW: Page Transition System --- */
    .page {
      width: 100%;
      max-width: 800px;
      background-color: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 20px 25px -5px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border);
      transition: opacity 0.4s ease-out, transform 0.4s ease-out, box-shadow 0.3s ease-in-out;
      opacity: 0;
      transform: translateY(20px);
      display: none; /* Hide all pages by default */
    }
    
    .page.visible {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    /* --- End NEW --- */


    /* Typography */
    h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-top: 0;
      color: var(--primary-600);
    }

    h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-900);
      margin-top: 0;
    }
    
    h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-900);
      margin-top: 24px;
      margin-bottom: 16px;
    }

    p {
      color: var(--text-500);
      line-height: 1.6;
      margin-bottom: 24px;
    }
    
    .list-container {
        max-width: 500px; 
        margin: 0 auto 30px; 
        text-align: left;
    }
    .list-container ul {
        list-style-type: disc; 
        padding-left: 20px; 
        color: var(--text-500);
        margin-top: 10px;
    }
    .list-container li {
        margin-bottom: 8px;
    }
    .list-container p {
        margin-top: 20px;
        margin-bottom: 0;
    }


    /* Form Styles */
    .form-grid {
      display: grid;
      gap: 20px;
      margin-bottom: 32px;
    }

    /* Responsive form grid */
    @media (min-width: 640px) {
      .form-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .grid-span-2 {
        grid-column: span 2 / span 2;
      }
    }

    label {
      display: block;
      font-weight: 500;
      color: var(--text-900);
      margin-bottom: 8px;
    }

    input[type="text"],
    input[type="email"],
    textarea { /* NEW: Added textarea */
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
      font-family: 'Inter', sans-serif; /* Ensure textarea inherits font */
    }
    
    /* NEW: Textarea specific style */
    textarea {
      min-height: 120px;
      resize: vertical;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    textarea:focus { /* NEW: Added textarea */
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px var(--primary-100);
      background-color: var(--primary-50);
    }

    /* Button Styles */
    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.215, 0.610, 0.355, 1.000);
      border: 1px solid transparent;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      min-width: 150px;
    }

    .btn:hover {
      box-shadow: 0 4px 10px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
    }

    .btn:active {
      transform: scale(0.98);
      box-shadow: 0 2px 4px -2px rgba(0, 0, 0, 0.05);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn.ghost {
      background-color: transparent;
      color: var(--text-500);
      border: 1px solid var(--border);
      box-shadow: none;
      min-width: 170px; /* slightly wider for 'Download Full Report' */
    }

    .btn.ghost:hover {
      background-color: var(--bg);
      color: var(--text-900);
      border-color: var(--primary-100);
    }

    .btn.accent {
      background-color: var(--primary-500);
      color: white;
    }

    .btn.accent:hover {
      background-color: var(--primary-600);
    }

    .btn.danger {
      background-color: var(--danger-500);
      color: white;
    }
    .btn.danger:hover {
      background-color: #C52929;
    }
    
    .controls {
      display: flex;
      justify-content: space-between; 
      align-items: center;
      gap: 16px;
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    
    .control-group { 
      display: flex;
      gap: 16px;
      align-items: center; /* NEW: Align dot with buttons */
    }
    
    /* --- NEW: Pulsing Red Dot for Recording --- */
    .recording-dot {
      width: 12px;
      height: 12px;
      background-color: var(--danger-500);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      margin-left: 10px; /* Space from 'Stop' button */
    }
    
    .recording-dot.is-recording {
      opacity: 1;
      animation: pulse-dot 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse-dot {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
    }
    /* --- End NEW --- */


    /* Intro Page */
    .illustration {
      font-size: 6rem;
      margin: 20px 0;
      line-height: 1;
      animation: bounceIn 1s ease-out forwards;
      color: var(--primary-600);
    }
    
    @keyframes bounceIn {
      0% { transform: scale(0.5); opacity: 0; }
      70% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); }
    }


    /* Practice Page */
    /* --- NEW: Animated Progress Bar --- */
    @keyframes progress-stripe {
      0% { background-position: 40px 0; }
      100% { background-position: 0 0; }
    }
    
    #progressBarContainer {
      height: 8px;
      background-color: var(--border);
      border-radius: 4px;
      margin-bottom: 24px;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    #progressBar {
      height: 100%;
      width: 0;
      background-color: var(--secondary-600);
      border-radius: 4px;
      transition: width 0.3s ease-out;
      /* NEW: Animated stripe */
      background-image: linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.2) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.2) 50%,
        rgba(255, 255, 255, 0.2) 75%,
        transparent 75%,
        transparent
      );
      background-size: 40px 40px;
      animation: progress-stripe 2s linear infinite;
    }
    /* --- End NEW --- */

    /* Stacked Avatar/Question Layout */
    .avatar-question-stack {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 20px;
        margin-bottom: 24px;
    }

    .qbox {
      width: 100%;
      border: 1px solid var(--primary-100);
      background-color: var(--primary-50);
      padding: 24px;
      border-radius: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      position: relative;
    }

    #qIndex {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--primary-600);
      margin-bottom: 8px;
    }

    #questionText {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-900);
      margin: 0;
    }
    
    #timerDisplay {
      margin-top: 16px;
      font-size: 1rem;
      font-weight: 500;
      color: var(--danger-500);
      text-align: center;
      transition: color 0.3s;
    }

    .transcript {
      min-height: 100px;
      padding: 16px;
      border: 1px dashed var(--border);
      border-radius: 8px;
      margin-top: 20px;
      font-style: italic;
      color: var(--text-500);
      background-color: white;
      transition: all 0.3s;
      line-height: 1.7;
    }
    .transcript.is-recording {
      border: 2px dashed var(--primary-500);
      background-color: var(--primary-50);
      color: var(--primary-600);
      font-style: normal;
      box-shadow: 0 0 0 4px var(--primary-100);
    }
    
    /* --- NEW: Enhanced Avatar States --- */
    @keyframes avatar-speak-pulse {
      0%, 100% { box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
    }
    
    #avatarContainer {
      width: 200px; 
      height: 200px;
      border-radius: 50%;
      background-color: var(--primary-100); 
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
      transition: all 0.5s ease-in-out;
      border: 4px solid var(--primary-500);
    }

    #avatarImage {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        transition: transform 0.3s ease-in-out, filter 0.3s ease-in-out;
    }
    
    /* State 1: Speaking */
    #avatarContainer.speaking {
      animation: avatar-speak-pulse 1.5s ease-out infinite; 
      border-color: var(--primary-600);
    }
    #avatarContainer.speaking #avatarImage {
        filter: brightness(1.05);
        transform: scale(1.02);
    }
    
    /* State 2: Listening (User is recording) */
    #avatarContainer.listening #avatarImage {
        filter: brightness(0.95) saturate(0.9);
    }
    /* --- End NEW --- */


    /* Results Page */
    #scoreSummary {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--secondary-600);
      text-align: center;
      margin-bottom: 24px;
      animation: popIn 0.5s 0.2s ease-out forwards;
      opacity: 0;
    }
    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    #overallFeedbackBox {
      background: var(--primary-50);
      border: 1px solid var(--primary-100);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      opacity: 0;
      animation: fadeIn 0.5s 0.2s ease-out forwards;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    #overallFeedbackBox h3 {
      margin-top: 0;
      color: var(--primary-600);
      font-size: 1.25rem;
    }
    #overallFeedbackBox ul {
      padding-left: 20px;
      margin-bottom: 0;
      list-style-type: disc;
    }
    #overallFeedbackBox li {
      margin-bottom: 8px;
      color: var(--text-500);
    }
    
    /* NEW: Pacing/Filler Word Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    .stat-item {
      background: white;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .stat-item-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-500);
      margin-bottom: 4px;
    }
    .stat-item-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-600);
    }

    #resultsTable {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 32px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      overflow: hidden;
    }

    #resultsTable th,
    #resultsTable td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      transition: background-color 0.2s;
    }

    #resultsTable th {
      background-color: var(--primary-50); 
      font-weight: 600;
      color: var(--text-900);
      font-size: 0.9rem;
    }
    #resultsTable tbody tr:last-child td {
        border-bottom: none;
    }
    #resultsTable tbody tr:hover {
        background-color: var(--primary-50);
    }

    #resultsTable td:nth-child(2) {
      font-weight: 600;
      color: var(--primary-600);
    }
    
    /* NEW: Staggered animation for feedback items */
    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .feedback-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      transition: box-shadow 0.3s;
      margin-bottom: 12px;
      opacity: 0; /* NEW */
      animation: slideInUp 0.5s ease-out forwards; /* NEW */
    }
    .feedback-item:hover {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
    
    .feedback-header {
      padding: 16px 24px;
      background-color: white;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    .feedback-item.open .feedback-header {
      background-color: var(--primary-50);
      border-bottom: 1px solid var(--primary-100);
    }
    .feedback-header:hover {
        background-color: var(--primary-50);
    }
    .feedback-header-left {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .feedback-header-left span {
        font-size: 0.875rem;
        color: var(--text-500);
        margin-top: 4px;
    }
    .feedback-score {
        font-weight: 700;
        min-width: 60px;
        text-align: right;
    }
    .feedback-score.high { color: var(--secondary-600); }
    .feedback-score.medium { color: var(--primary-500); }
    .feedback-score.low { color: var(--danger-500); }
    .feedback-toggle {
        font-size: 1.2rem;
        margin-left: 10px;
        transition: transform 0.3s;
    }
    .feedback-item.open .feedback-toggle {
        transform: rotate(180deg);
    }

    .feedback-body {
      max-height: 0;
      overflow: hidden;
      padding: 0 24px;
      transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
      background-color: var(--primary-50);
    }
    .feedback-item.open .feedback-body {
      max-height: 1000px; /* Increased max-height */
      padding: 24px;
    }
    
    .feedback-body h4 {
        font-size: 1rem;
        margin-top: 10px;
        margin-bottom: 8px;
        color: var(--primary-600);
    }
    .feedback-answer {
        background-color: white;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--border);
        color: var(--text-900);
        line-height: 1.7;
    }
    
    .keyword-highlight {
        background-color: var(--secondary-100);
        font-weight: 600;
        padding: 2px 4px;
        border-radius: 4px;
        color: var(--secondary-600);
        white-space: nowrap;
        margin-right: 2px;
    }
    
    .keyword-missed {
        background-color: var(--danger-100);
        font-weight: 500;
        color: var(--danger-500);
        padding: 2px 4px;
        border-radius: 4px;
        white-space: nowrap;
        margin-right: 2px;
    }
    
    .feedback-suggestion ul {
        list-style-type: disc;
        padding-left: 20px;
        margin-top: 8px;
        margin-bottom: 0;
    }
    .feedback-suggestion li {
        margin-bottom: 4px;
    }


    /* Processing Overlay */
    #processingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    
    .spinner {
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary-500);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    #processingOverlay p {
      margin-top: 20px;
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--primary-600);
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
@media (max-width: 480px) {
  .controls {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }

  .control-group {
    width: 100%;
    justify-content: space-between;
  }

  #nextBtn {
    width: 100%;
  }
}

  
#overallFeedbackBox { margin-top:0!important; padding-top:0!important; }
#scoreSummary { margin-bottom:8px!important; }


#resultsPage h2 { margin-bottom:8px!important; }
#resultsPage p { margin-bottom:4px!important; }
#scoreSummary { margin:4px 0!important; }
#overallFeedbackBox { margin:4px 0!important; }

</style>
</head>

<body>

  <div id="processingOverlay">
    <div class="spinner"></div>
    <p>Analyzing your answer...</p>
  </div>

  <div class="page" id="formPage"> <h1>Insmot AI Interview Coach</h1>
    <p>Let‚Äôs begin by understanding you better. This will help tailor the session.</p>

    <div class="form-grid">
      <div>
        <label for="nameInput">Full Name</label>
        <input type="text" id="nameInput" placeholder="Enter your full name" />
      </div>
      <div>
        <label for="emailInput">Email</label>
        <input type="email" id="emailInput" placeholder="Enter your email" />
      </div>
      <div>
        <label for="degreeInput">Highest Degree/Major</label>
        <input type="text" id="degreeInput" placeholder="e.g., B.Tech CS, MBA Finance" />
      </div>
      <div>
        <label for="yearInput">Graduation Year</label>
        <input type="text" id="yearInput" placeholder="e.g., 2025" />
      </div>
      
      <div class="grid-span-2">
        <label for="jobDescInput">Paste Job Description (Optional)</label>
        <textarea id="jobDescInput" placeholder="Paste the job description here to get more relevant questions..."></textarea>
      </div>
      </div>

    <div class="controls" style="justify-content: flex-end;">
      <button class="btn accent" id="startIntro">Continue</button>
    </div>
  </div>

  <div class="page" id="introPage" style="text-align:center;"> <div class="illustration">üéôÔ∏è</div>
    <h2 id="welcomeText">Hello, Welcome!</h2>
    
    <div class="list-container">
        <p style="font-weight: 600; color: var(--primary-600); margin-bottom: 10px;" id="simulationRulesHeader">Simulation Rules (6 Questions):</p>
        <ul style="list-style-type: disc; padding-left: 20px; color: var(--text-500);">
            <li>I will ask you behavioral and technical questions relevant to your background.</li>
            <li>Use the <strong>"Start Recording"</strong> button to begin speaking and <strong>"Stop Recording"</strong> when finished.</li>
            <li>Your answer is analyzed immediately based on <strong>keyword inclusion, structure, pacing, and filler words.</strong></li>
            <li>Click <strong>"Next Question"</strong> to proceed.</li>
            <li>Your full score and comprehensive report will be generated after the final question.</li>
        </ul>
        <p style="margin-top: 20px;">We recommend enabling microphone access now. Good luck!</p>
    </div>
    
    <div class="controls" style="justify-content: center; border-top: none; padding-top: 0;">
      <button class="btn accent" id="goToQuestions">Start Interview</button>
    </div>
  </div>

  <div class="page" id="practicePage"> <h2 id="practiceHeader">Interview Simulation</h2>
    
    <div id="progressBarContainer">
      <div id="progressBar"></div>
    </div>
    
    <div class="avatar-question-stack">
      
      <div id="avatarContainer">
        <img id="avatarImage" 
        src="https://raw.githubusercontent.com/jnit005/interview-practice/main/2222.png" 
        alt="AI Interview Coach Avatar" 
        onerror="this.src='https://placehold.co/200x200/4F46E5/FFFFFF/png?text=Avatar'" 
       />
        </div>
      
      <div class="qbox">
        <p id="qIndex">Question 1 of 6</p>
        <p id="questionText">Loading question...</p>
      </div>
    </div>

    
    <div id="timerDisplay">Recording Time: 00:00</div>
    
    <div class="transcript" id="transcript">Click "Start Recording" to begin your answer.</div>
    
    <div class="controls">
      <div class="control-group">
        <button class="btn accent" id="recordBtn">Start Recording</button>
        <button class="btn danger" id="stopBtn" disabled>Stop Recording</button>
        <div class="recording-dot" id="recordingDot"></div>
        </div>
      <button class="btn ghost" id="nextBtn" disabled>Next Question</button>
    </div>
  </div>

  <div class="page" id="resultsPage"> <h2>Your Interview Report</h2>
    <p>Here is a detailed breakdown of your performance.</p>
    
    <div id="scoreSummary">Overall Score: 0%</div>
    
    <div id="overallFeedbackBox">
      </div>
    
    <h3>Question-wise Breakdown</h3>
    <table id="resultsTable">
      <thead>
        <tr>
          <th>Question</th>
          <th style="width: 15%;">Score</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="feedbackContainer">
      </div>
    
    <div class="controls">
      <button class="btn ghost" id="restartBtn">Start New Interview</button>
      <button class="btn accent" id="downloadBtn">Download Full Report (PDF)</button>
    </div>
  </div>

  <script>
    // Utility function for getting elements by ID
    const $ = id => document.getElementById(id);

    // Global state variables
    let recognition = null;
    let isRecording = false;
    let timerInterval = null;
    let seconds = 0;
    let finalTranscript = '';
    let responses = []; // Will now store objects: { answer, time, wpm, fillerWords }
    let breakdown = [];
    let user = {};

    // Element references
    const processingOverlay = $('processingOverlay');
    const recordBtn = $('recordBtn');
    const stopBtn = $('stopBtn');
    const nextBtn = $('nextBtn');
    const transcriptEl = $('transcript');
    const timerDisplay = $('timerDisplay');
    const avatarContainer = $('avatarContainer'); 
    const recordingDot = $('recordingDot'); // NEW
    const qbox = document.querySelector('.qbox'); 
    
    // NATIVE TTS: Use browser's SpeechSynthesis for reliable voice output
    let synth = window.speechSynthesis;
    let currentUtterance = null;
    let preferredVoice = null; 

    // Ensure voices are loaded before we try to select one
    if (synth) {
      synth.onvoiceschanged = () => {
        const voices = synth.getVoices();
        preferredVoice =
  voices.find(v => v.name.includes("Google UK English Female")) ||
  voices.find(v => v.name.includes("Google US English Female")) ||
  voices.find(v => v.name === "Samantha") ||
  voices.find(v => v.name === "Karen") ||
  voices.find(v => v.name === "Moira") ||
  voices.find(v => v.name === "Tessa") ||
  voices.find(v => v.name === "Victoria") ||
  voices.find(v => v.lang.startsWith("en") && v.name.toLowerCase().includes("female")) ||
  voices.find(v => v.lang.startsWith("en")) ||
  voices[0];
      // Force Samantha on iOS
      if (/iphone|ipad|ipod/i.test(navigator.userAgent)) {
        const samantha = voices.find(v => v.name === "Samantha");
        if (samantha) preferredVoice = samantha;
      }
      };
    }

    // --- NEW: Question Pool System ---
    const BASE_QUESTIONS = [
      { 
        q: "Tell me a little about yourself and your background.", 
        keywords: ["relevant experience", "education", "passion", "career goals", "summary", "brief overview"]
      },
      { 
        q: "What are your greatest strengths?", 
        keywords: ["problem-solving", "teamwork", "collaborate", "communication", "leadership", "adaptable", "quick learner", "detail-oriented", "time management", "dedicated"]
      },
      { 
        q: "What do you consider to be your weaknesses?", 
        keywords: ["self-improvement", "learning", "growth mindset", "managing", "delegating", "overcoming", "developing"]
      },
      { 
        q: "Why should we hire you for this position?", 
        keywords: ["unique value", "skills align", "enthusiasm", "achievements", "solve problems", "cultural fit", "long-term commitment"]
      },
      { 
        q: "Where do you see yourself in 5 years?", 
        keywords: ["professional growth", "leadership role", "contribution", "industry expertise", "learning new skills", "specific company goals"]
      },
      {
        q: "Describe a challenging situation you faced at work or in a project, and how you handled it.",
        keywords: ["situation", "task", "action", "result", "star method", "solution", "outcome", "learned"]
      }
    ];

    const QUESTION_POOLS = {
      technical: [
        { q: "Describe a complex project you worked on. What was the tech stack and what was your role?", keywords: ["architecture", "tech stack", "role", "database", "api", "frontend", "backend", "deployment", "agile"] },
        { q: "How do you stay updated with the latest technology trends in your field?", keywords: ["blogs", "documentation", "side projects", "conferences", "learning", "communities"] },
        { q: "Explain a technical concept (like a RESTful API or a closure) as if you were speaking to a non-technical manager.", keywords: ["simple terms", "analogy", "clear", "concise", "business value"] }
      ],
      marketing: [
        { q: "Describe a successful marketing campaign you were part of. What was your contribution and what were the results?", keywords: ["campaign", "kpi", "roi", "metrics", "channels", "seo", "sem", "social media", "analytics"] },
        { q: "How do you identify and understand a target audience?", keywords: ["market research", "persona", "segmentation", "data analysis", "customer feedback", "surveys"] },
        { q: "What's your experience with marketing analytics tools?", keywords: ["google analytics", "hubspot", "salesforce", "data-driven", "reporting", "funnel", "conversion"] }
      ],
      finance: [
        { q: "Describe your experience with financial modeling. What models have you built?", keywords: ["dcf", "lbo", "3-statement", "valuation", "excel", "forecasting", "sensitivity analysis", "assumptions"] },
        { q: "How do you assess the financial health of a company?", keywords: ["financial statements", "ratios", "liquidity", "profitability", "solvency", "cash flow", "balance sheet"] },
        { q: "Walk me through the three financial statements.", keywords: ["income statement", "balance sheet", "cash flow statement", "net income", "assets", "liabilities", "equity", "operating", "investing", "financing"] }
      ]
    };
    
    // This will be our active set of questions for the session
    let QUESTIONS = [...BASE_QUESTIONS]; 
    let current = 0;
    
    // --- NEW: Page Navigation System ---
    let currentPage = 'formPage';
    
    function showPage(pageId) {
      const newPage = $(pageId);
      if (!newPage) return;

      const oldPage = $(currentPage);
      if (oldPage) {
        oldPage.classList.remove('visible');
        // Wait for fade-out to finish before fading in new page
        setTimeout(() => {
          oldPage.style.display = 'none';
          newPage.style.display = 'block';
          // Force reflow to ensure animation plays
          void newPage.offsetWidth; 
          newPage.classList.add('visible');
          currentPage = pageId;
        }, 400); // Should match CSS transition duration
      } else {
        // First page load
        newPage.style.display = 'block';
        void newPage.offsetWidth;
        newPage.classList.add('visible');
        currentPage = pageId;
      }
    }
    // --- End NEW ---
    
    
    // --- NEW: LocalStorage Functions ---
    function saveUserToLocal() {
      try {
        localStorage.setItem('insmotUser', JSON.stringify(user));
      } catch (e) {
        console.warn("Could not save user to localStorage", e);
      }
    }
    
    function loadUserFromLocal() {
      try {
        const storedUser = localStorage.getItem('insmotUser');
        if (storedUser) {
          user = JSON.parse(storedUser);
          $('nameInput').value = user.name || '';
          $('emailInput').value = user.email || '';
          $('degreeInput').value = user.degree || '';
          $('yearInput').value = user.year || '';
        }
      } catch (e) {
        console.warn("Could not load user from localStorage", e);
      }
    }
    // --- End NEW ---


    // ---------------------------------------------
    // TTS Speech
    // ---------------------------------------------
    function speak(text) {
      if (!synth) {
        console.error('Browser does not support Speech Synthesis.');
        return;
      }

      if (currentUtterance) {
        synth.cancel(); 
      }

      const utterance = new SpeechSynthesisUtterance(text);
      if (preferredVoice) {
        utterance.voice = preferredVoice;
      } else {
        setTimeout(() => {
          const voices = synth.getVoices();
          const samantha = voices.find(v => v.name === "Samantha");
          if (samantha) utterance.voice = samantha;
          synth.speak(utterance);
        }, 200);
        return;
      }
      utterance.rate = 0.95; 
      utterance.pitch = 1.0;
      
      utterance.onstart = () => {
        avatarContainer.classList.add('speaking'); // NEW: Updated class
        avatarContainer.classList.remove('listening');
        qbox.style.transform = 'scale(1.02)';
      };

      utterance.onend = () => {
        avatarContainer.classList.remove('speaking');
        qbox.style.transform = 'scale(1.0)';
        currentUtterance = null;
      };
      
      utterance.onerror = (event) => {
        console.error('SpeechSynthesisUtterance error: ' + event.error);
        avatarContainer.classList.remove('speaking');
        qbox.style.transform = 'scale(1.0)';
        currentUtterance = null;
      };

      currentUtterance = utterance;
      synth.speak(utterance);
    }
    
    // ---------------------------------------------
    // Speech Recognition Setup (Called once)
    // ---------------------------------------------
    function initRec() {
      try {
        const R = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!R) {
          transcriptEl.textContent = 'Speech Recognition not supported in this browser.';
          recordBtn.disabled = true;
          return;
        }
        
        recognition = new R();
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        recognition.continuous = false; 

        recognition.currentFinalTranscript = ''; 

        recognition.onresult = e => {
  const text = e.results[0][0].transcript;
  recognition.currentFinalTranscript = text;
  transcriptEl.textContent = text;
};

        recognition.onstart = () => {
          isRecording = true;
          recordBtn.disabled = true;
          stopBtn.disabled = false;
          nextBtn.disabled = true;
          transcriptEl.classList.add('is-recording');
          avatarContainer.classList.add('listening'); // NEW
          avatarContainer.classList.remove('speaking'); // NEW
          recordingDot.classList.add('is-recording'); // NEW
          timerDisplay.style.color = 'var(--secondary-600)'; 
          startTimer();
          transcriptEl.textContent = 'Listening...';
        };
        
        recognition.onend = () => {
          if (isRecording) { 
            stopRecording(); // NEW: Refactored to use the stop function
          }
        };

        recognition.onerror = (e) => {
          console.error("Recognition Error:", e);
          if (e.error === 'not-allowed' || e.error === 'permission-denied') {
            transcriptEl.textContent = 'Microphone access denied. Please enable it in your browser settings to continue.';
          } else if (e.error !== 'aborted') {
             transcriptEl.textContent = `Error: ${e.error}`;
          }
          avatarContainer.classList.remove('listening');
          recordingDot.classList.remove('is-recording');
          timerDisplay.style.color = 'var(--danger-500)'; 
        };
        
      } catch (err) {
        console.error("Error initializing SpeechRecognition:", err);
      }
    }
    
    // ---------------------------------------------
    // Timer Functions
    // ---------------------------------------------
    function updateTimer() {
      seconds++;
      const minutes = String(Math.floor(seconds / 60)).padStart(2, '0');
      const remainingSeconds = String(seconds % 60).padStart(2, '0');
      timerDisplay.textContent = `Recording Time: ${minutes}:${remainingSeconds}`;
    }
    
    function startTimer() {
      seconds = 0;
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }
    
    function stopTimer() {
      clearInterval(timerInterval);
    }
    
    function resetTimer() {
      stopTimer();
      seconds = 0;
      timerDisplay.textContent = `Recording Time: 00:00`;
      timerDisplay.style.color = 'var(--danger-500)';
    }

    // ---------------------------------------------
    // Page 1: Start Intro
    // ---------------------------------------------
    $('startIntro').onclick = () => {
      user = {
        name: $('nameInput').value.trim(),
        degree: $('degreeInput').value.trim(),
        year: $('yearInput').value.trim(),
        email: $('emailInput').value.trim(),
        jobDesc: $('jobDescInput').value.trim(), // NEW
      };

      if (!user.name || !user.email) {
        const nameInput = $('nameInput');
        nameInput.style.borderColor = 'var(--danger-500)';
        nameInput.placeholder = 'Required!';
        setTimeout(() => { nameInput.style.borderColor = 'var(--border)'; }, 1000);
        return;
      }
      
      saveUserToLocal(); // NEW: Save details
      
      // --- NEW: Build Custom Question Set ---
      buildQuestionSet(user.jobDesc);
      // --- End NEW ---
      
      $('welcomeText').textContent = `Hello ${user.name}, welcome!`;
      const introMessage = `Hello ${user.name}, welcome to your Insmot Interview Practice. This test will take about 10 to 15 minutes. All the best.`;
      speak(introMessage);

      showPage('introPage');
    };
    
    // --- NEW: Question Set Builder ---
    function buildQuestionSet(jobDesc) {
      QUESTIONS = [...BASE_QUESTIONS]; // Reset to default
      let jd = jobDesc.toLowerCase();
      
      // Shuffle function
      const shuffle = (array) => array.sort(() => 0.5 - Math.random());
      
      let relevantPool = [];
      
      if (jd.includes('react') || jd.includes('node') || jd.includes('javascript') || jd.includes('developer') || jd.includes('software engineer')) {
        relevantPool = [...QUESTION_POOLS.technical];
      } else if (jd.includes('marketing') || jd.includes('seo') || jd.includes('social media') || jd.includes('brand')) {
        relevantPool = [...QUESTION_POOLS.marketing];
      } else if (jd.includes('finance') || jd.includes('accounting') || jd.includes('investment') || jd.includes('analyst')) {
        relevantPool = [...QUESTION_POOLS.finance];
      }
      
      if (relevantPool.length > 0) {
        // Swap out two general questions for two relevant ones
        let_ = shuffle(relevantPool).slice(0, 2);
        QUESTIONS[1] = relevantPool[0]; // Replace "Strengths"
        QUESTIONS[3] = relevantPool[1]; // Replace "Why hire you"
        
        $('simulationRulesHeader').textContent = `Simulation Rules (${QUESTIONS.length} Tailored Questions):`;
      } else {
        $('simulationRulesHeader').textContent = `Simulation Rules (${QUESTIONS.length} Questions):`;
      }
    }
    // --- End NEW ---
    
    // ---------------------------------------------
    // Page 2: Go To Questions
    // ---------------------------------------------
    $('goToQuestions').onclick = () => {
      showPage('practicePage');
      $('practiceHeader').textContent = `Interview Simulation`;
      initRec();
      updateQ();
    };
    
    // ---------------------------------------------
    // Page 3: Load Question
    // ---------------------------------------------
    function updateQ() {
      if (recognition) {
         recognition.currentFinalTranscript = ''; 
      }
      resetTimer();
      stopBtn.disabled = true;
      nextBtn.disabled = true;
      recordBtn.disabled = false;
      avatarContainer.classList.remove('speaking');
      avatarContainer.classList.remove('listening');

      $('qIndex').textContent = `Question ${current + 1} of ${QUESTIONS.length}`;
      
      const question = QUESTIONS[current];
      $('questionText').textContent = question.q;
      transcriptEl.textContent = 'Click "Start Recording" to begin your answer.';
      
      speak(question.q);
      
      const progress = ((current) / QUESTIONS.length) * 100;
      $('progressBar').style.width = `${progress}%`;
    }

    // ---------------------------------------------
    // Page 3: Recording Controls
    // ---------------------------------------------
    function startRecording() {
      if (!recognition) {
        transcriptEl.textContent = 'Speech Recognition is not ready.';
        return;
      }
      if (isRecording) return;
      
      try {
        recognition.currentFinalTranscript = ''; 
        recognition.start(); 
      } catch(e) {
        console.error("Error starting recognition: ", e);
      }
    }
    
    function stopRecording() {
      if (!isRecording) return;
      
      isRecording = false; 

      if (recognition && recognition.abort) {
        recognition.abort(); 
      }
      stopTimer();
      
      // --- NEW: Store advanced response data ---
      const answerText = recognition.currentFinalTranscript.trim() || transcriptEl.textContent.replace('Listening...', '').trim() || 'No answer recorded.';
      const answerTime = seconds > 0 ? seconds : 1; // Avoid division by zero
      
      const { wpm, wordCount } = calculateWPM(answerText, answerTime);
      const fillerWordCount = countFillerWords(answerText);
      
      responses[current] = {
        answer: answerText,
        time: answerTime,
        wpm: wpm,
        wordCount: wordCount,
        fillerWords: fillerWordCount
      };
      // --- End NEW ---
      
      transcriptEl.textContent = answerText;
      recordBtn.disabled = false;
      stopBtn.disabled = true;
      nextBtn.disabled = (answerText === 'No answer recorded.');
      transcriptEl.classList.remove('is-recording');
      avatarContainer.classList.remove('listening'); // NEW
      recordingDot.classList.remove('is-recording'); // NEW
    }

    recordBtn.onclick = startRecording;
    stopBtn.onclick = stopRecording;

    // ---------------------------------------------
    // Page 3: Next Question
    // ---------------------------------------------
    $('nextBtn').onclick = () => {
      stopRecording(); 
      
      processingOverlay.style.display = 'flex'; 
      
      requestAnimationFrame(() => {
        processingOverlay.style.display = 'none'; 
        
        current++;
        if (current < QUESTIONS.length) {
          updateQ();
        } else {
          $('progressBar').style.width = `100%`;
          finishTest();
        }
      });
    };

    // ---------------------------------------------
    // Scoring Engine & Feature Analysis
    // ---------------------------------------------
    
    // --- NEW: Filler Word Counter ---
    const FILLER_WORDS = /\b(um|uh|ah|like|you know|so|actually|basically|literally|i mean|right)\b/gi;
    
    function countFillerWords(text) {
      const matches = text.match(FILLER_WORDS);
      return matches ? matches.length : 0;
    }
    
    // --- NEW: WPM Calculator ---
    function calculateWPM(text, timeInSeconds) {
      if (!text || text === 'No answer recorded.' || timeInSeconds === 0) {
        return { wpm: 0, wordCount: 0 };
      }
      const wordCount = text.split(/\s+/).length;
      const wpm = Math.round((wordCount / timeInSeconds) * 60);
      return { wpm, wordCount };
    }
    
    function getPacingFeedback(wpm) {
      if (wpm < 110) return "A bit slow";
      if (wpm > 160) return "A bit fast";
      return "Clear and deliberate";
    }

    function score(ans, keys) {
      if (!ans || ans.trim() === 'No answer recorded.') return { score: 0, matched: [] };
      
      const lowerAns = ans.toLowerCase();
      let matched = [];
      
      keys.forEach(key => {
        if (lowerAns.includes(key.toLowerCase())) {
          matched.push(key);
        }
      });
      
      const finalScore = Math.round((matched.length / keys.length) * 100);
      
      return { score: finalScore, matched: matched };
    }

    // ---------------------------------------------
    // Page 4: Final Feedback Screen
    // ---------------------------------------------
    let overallFeedbackText = ""; // For PDF
    
    function finishTest() {
      showPage('resultsPage');
      
      breakdown = [];
      let tbody = $('resultsTable').querySelector('tbody');
      tbody.innerHTML = '';

      let totalScore = 0;
      let totalWPM = 0;
      let totalFillerWords = 0;
      let answeredQuestions = 0;

      QUESTIONS.forEach((q, i) => {
        const responseData = responses[i] || { answer: "No answer recorded.", wpm: 0, fillerWords: 0, time: 0 };
        const r = score(responseData.answer, q.keywords);
        
        totalScore += r.score;
        if (responseData.answer !== "No answer recorded.") {
          totalWPM += responseData.wpm;
          totalFillerWords += responseData.fillerWords;
          answeredQuestions++;
        }
        
        const resultData = {
          question: q.q,
          score: r.score,
          keywordsHit: r.matched,
          allKeywords: q.keywords,
          ...responseData // Includes answer, wpm, fillerWords, time
        };
        breakdown.push(resultData);
        
        tbody.innerHTML += `
          <tr>
            <td>${q.q.substring(0, 40)}${q.q.length > 40 ? '...' : ''}</td>
            <td class="feedback-score ${r.score >= 80 ? 'high' : r.score >= 50 ? 'medium' : 'low'}">${r.score}%</td>
          </tr>`;
      });

      let avgScore = Math.round(totalScore / QUESTIONS.length);
      let avgWPM = answeredQuestions > 0 ? Math.round(totalWPM / answeredQuestions) : 0;
      
      $('scoreSummary').textContent = `Overall Score: ${avgScore}%`;
      
      speak(`Your interview is complete. Your overall score is ${avgScore} percent. Please review your detailed feedback below.`);

      showOverallFeedback(avgScore, avgWPM, totalFillerWords); 
      showQuestionFeedback(breakdown);
    }
    
    // ---------------------------------------------
    // Overall Feedback Box (Enhanced)
    // ---------------------------------------------
    function showOverallFeedback(avg, avgWPM, totalFillerWords) {
      const box = $('overallFeedbackBox');
      let title = "";
      let points = [];
      
      if (avg >= 80) {
        title = "Excellent Job!";
        overallFeedbackText = "You've demonstrated a strong understanding of the topics and hit most key points. Your communication seems clear and confident.";
        points = [
          "Great use of relevant keywords and examples.",
          "Your answers are well-structured and confident.",
          "Maintain that high level of detail in real interviews."
        ];
      } else if (avg >= 50) {
        title = "Solid Performance!";
        overallFeedbackText = "You have a good foundation, but there's room for improvement. Focus on adding more depth and structure to your answers.";
        points = [
          "Good start, but try to include more specific examples and metrics.",
          "Review the 'Keywords to Include' to see what you missed.",
          "Focus on structuring your answers more clearly (e.g., STAR method)."
        ];
      } else {
        title = "Needs Improvement";
        overallFeedbackText = "This is a great first step in practicing. The key now is to focus on adding more substance and relevant keywords to your answers.";
        points = [
          "Your answers are missing key concepts. Study the job description and common answers.",
          "Practice including more keywords from the suggestions below.",
          "Try to provide real-life examples, even from college projects."
        ];
      }
      
      box.innerHTML = `
        <h3>${title}</h3>
        <p>${overallFeedbackText}</p>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-item-label">Avg. Pacing (WPM)</div>
            <div class="stat-item-value">${avgWPM}</div>
            <div class="stat-item-label" style="margin-top:4px;">(${getPacingFeedback(avgWPM)})</div>
          </div>
          <div class="stat-item">
            <div class="stat-item-label">Total Filler Words</div>
            <div class="stat-item-value">${totalFillerWords}</div>
            <div class="stat-item-label" style="margin-top:4px;">(e.g., um, like, so)</div>
          </div>
        </div>
        <h3 style="margin-top: 24px; margin-bottom: 16px;">Key Takeaways:</h3>
        <ul>
          ${points.map(p => `<li>${p}</li>`).join('')}
        </ul>
      `;
    }
    
    // ---------------------------------------------
    // Detailed Question Feedback UI (Enhanced)
    // ---------------------------------------------
    function showQuestionFeedback(breakdown) {
      const container = $('feedbackContainer');
      container.innerHTML = '';
      
      breakdown.forEach((b, i) => {
        const keywordsMissed = b.allKeywords.filter(k => !b.answer.toLowerCase().includes(k.toLowerCase()));
        
        let scoreClass = 'medium';
        if (b.score >= 80) scoreClass = 'high';
        if (b.score < 50) scoreClass = 'low';
        
        const feedbackItem = document.createElement('div');
        feedbackItem.className = 'feedback-item';
        // NEW: Staggered animation delay
        feedbackItem.style.animationDelay = `${i * 100}ms`;
        
        feedbackItem.innerHTML = `
          <div class="feedback-header" data-index="${i}">
            <div class="feedback-header-left">
              <strong>Q${i+1}. ${b.question}</strong>
              <span>Keywords Hit: ${b.keywordsHit.length} / ${b.allKeywords.length}</span>
            </div>
            <div class="feedback-score ${scoreClass}">${b.score}%</div>
            <span class="feedback-toggle">‚ñº</span>
          </div>
          <div class="feedback-body" id="feedbackBody-${i}">
            
            <div class="stats-grid" style="margin-bottom: 20px;">
              <div class="stat-item">
                <div class="stat-item-label">Pacing</div>
                <div class="stat-item-value">${b.wpm} <span style="font-size: 1rem; font-weight: 500;">WPM</span></div>
              </div>
              <div class="stat-item">
                <div class="stat-item-label">Filler Words</div>
                <div class="stat-item-value">${b.fillerWords}</div>
              </div>
            </div>
          
            <h4>Your Answer Transcript:</h4>
            <div class="feedback-answer">
              ${highlightKeywords(b.answer, b.keywordsHit)}
            </div>
            
            <h4>Keywords Analysis:</h4>
            <p>
              <span class="keyword-highlight">Hit: ${b.keywordsHit.join(', ') || 'None'}</span><br>
              <span class="keyword-missed">Missed: ${keywordsMissed.join(', ') || 'None'}</span>
            </p>
            
            <h4>Suggestion for Improvement:</h4>
            <div class="feedback-suggestion">
              ${getSuggestion(b.score, i, keywordsMissed)}
            </div>
          </div>
        `;
        
        container.appendChild(feedbackItem);
        
        // Add click listener for accordion
        feedbackItem.querySelector('.feedback-header').onclick = (e) => {
          const body = feedbackItem.querySelector('.feedback-body');
          if (feedbackItem.classList.contains('open')) {
            feedbackItem.classList.remove('open');
          } else {
            // Close all others
            container.querySelectorAll('.feedback-item.open').forEach(item => item.classList.remove('open'));
            feedbackItem.classList.add('open');
          }
        };
      });
    }
    
    function highlightKeywords(answer, keywords) {
      if (!answer) return "No answer recorded.";
      let highlighted = answer;
      const uniqueKeywords = [...new Set(keywords)].sort((a, b) => b.length - a.length); 
      
      uniqueKeywords.forEach(keyword => {
        const regex = new RegExp(`(${keyword})`, 'gi');
        highlighted = highlighted.replace(regex, '<span class="keyword-highlight">$1</span>');
      });
      return highlighted;
    }
    
    function getSuggestion(score, index, missedKeywords) {
      let suggestion = '';
      
      if (score < 50) {
        suggestion += `This answer needs significant improvement. It is currently missing key concepts required for a high score. Focus on integrating terms like <b>${missedKeywords.slice(0, 3).join(', ')}</b> to add substance.`;
      }
      
      // Specific suggestion for behavioral question (index 5)
      if (QUESTIONS[index].q.includes("challenging situation")) {
        suggestion += `<strong>Tip:</strong> For behavioral questions like this, always use the <b>STAR method</b>:
                      <ul>
                        <li><strong>S</strong>ituation: Describe the context.</li>
                        <li><strong>T</strong>ask: Explain your goal.</li>
                        <li><strong>A</strong>ction: Detail the steps you took.</li>
                        <li><strong>R</strong>esult: State the positive outcome and what you learned.</li>
                      </ul>`;
      } else if (score >= 50 && score < 80) {
        suggestion += `This is a good start! To make it stronger, try adding more specific examples or metrics that demonstrate your skills. You could also try to naturally include terms like <b>${missedKeywords.slice(0, 1).join(', ')}</b>.`;
      } else if (score >= 80) {
        suggestion += `Excellent answer! Your response was comprehensive and well-structured. To make it perfect, ensure you link your answer directly back to the specific company/role you are applying for.`;
      }
      return suggestion;
    }
    
    // ---------------------------------------------
    // PDF Download Logic (Enhanced)
    // ---------------------------------------------
    $('downloadBtn').onclick = () => {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const margin = 20;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const textWidth = pageWidth - (margin * 2);
        let y = margin;
        const lineHeight = 7;
        
        function addText(text, x, yPos, options = {}) {
          doc.setFontSize(options.size || 10);
          doc.setFont('helvetica', options.font || 'normal');
          
          const lines = doc.splitTextToSize(text, textWidth - (x - margin));
          
          if (yPos + (lines.length * lineHeight) > pageHeight - margin) {
            doc.addPage();
            y = margin;
            y = addText("--- Report Continued ---", margin, y, { font: 'bold', size: 10 });
            y += lineHeight * 0.5;
          }
          
          lines.forEach(line => {
            doc.text(line, x, y, { align: options.align });
            y += lineHeight;
          });
          
          return y; 
        }

        // --- 1. Title ---
        y = addText("Insmot AI Interview Report", pageWidth / 2, y, { align: 'center', size: 20, font: 'bold' });
        y += lineHeight * 0.5;

        // --- 2. User Details ---
        y = addText("Candidate Details", margin, y, { size: 14, font: 'bold' });
        doc.line(margin, y - (lineHeight * 0.5), pageWidth - margin, y - (lineHeight * 0.5));
        y += lineHeight * 0.5;
        
        y = addText(`Name: ${user.name || 'N/A'}`, margin, y);
        y = addText(`Email: ${user.email || 'N/A'}`, margin, y);
        y = addText(`Degree: ${user.degree || 'N/A'}`, margin, y);
        y += lineHeight; 
        
        // --- 3. Overall Score & Feedback ---
        let totalScore = breakdown.reduce((sum, item) => sum + item.score, 0);
        let avgScore = Math.round(totalScore / QUESTIONS.length);
        let answered = breakdown.filter(b => b.answer !== "No answer recorded.").length;
        let avgWPM = answered > 0 ? Math.round(breakdown.reduce((sum, item) => sum + item.wpm, 0) / answered) : 0;
        let totalFillers = breakdown.reduce((sum, item) => sum + item.fillerWords, 0);

        
        y = addText("Overall Performance", margin, y, { size: 14, font: 'bold' });
        doc.line(margin, y - (lineHeight * 0.5), pageWidth - margin, y - (lineHeight * 0.5));
        y += lineHeight * 0.5;
        
        y = addText(`Final Score: ${avgScore}%`, margin, y, { size: 16, font: 'bold' });
        y = addText(`Avg. Pacing: ${avgWPM} WPM (${getPacingFeedback(avgWPM)})`, margin, y, { size: 12 });
        y = addText(`Total Filler Words: ${totalFillers}`, margin, y, { size: 12 });
        y += lineHeight * 0.5;

        y = addText("Summary Feedback:", margin, y, { size: 11, font: 'bold' });
        y = addText(overallFeedbackText, margin, y); 
        y += lineHeight;

        // --- 4. Question Breakdown ---
        y = addText("Detailed Analysis & Suggestions", margin, y, { size: 14, font: 'bold' });
        doc.line(margin, y - (lineHeight * 0.5), pageWidth - margin, y - (lineHeight * 0.5));
        y += lineHeight;

        breakdown.forEach((b, i) => {
          const missed = b.allKeywords.filter(k => !b.answer.toLowerCase().includes(k.toLowerCase()));
          
          let suggestionClean = getSuggestion(b.score, i, missed)
            .replace(/<br\s*\/?>/gi, '\n')
            .replace(/<\/li>/gi, '\n* ')   
            .replace(/<li>/gi, ' * ')      
            .replace(/<[^>]*>?/gm, '')    
            .replace(/\s\s+/g, ' ')        
            .trim(); 

          if (y > pageHeight - 80) {
            doc.addPage();
            y = margin;
          }
          
          y = addText(`Q${i+1}: ${b.question}`, margin, y, { size: 11, font: 'bold' });
          y = addText(`Score: ${b.score}%   |   Pacing: ${b.wpm} WPM   |   Filler Words: ${b.fillerWords}`, margin, y, { font: 'bold', size: 10 });
          y += lineHeight * 0.5;
          
          y = addText("Your Answer:", margin, y, { font: 'italic', size: 10 });
          y = addText(b.answer || "No answer recorded.", margin + 5, y, { font: 'normal', size: 10 });
          y += lineHeight * 0.5;

          y = addText(`Keywords Hit:`, margin, y, { font: 'bold', size: 10 });
          y = addText(b.keywordsHit.join(', ') || 'None', margin + 5, y);
          y = addText(`Keywords to Include:`, margin, y, { font: 'bold', size: 10 });
          y = addText(missed.join(', ') || 'None', margin + 5, y);
          y += lineHeight * 0.5;
          
          y = addText(`Suggestion:`, margin, y, { font: 'bold', size: 10 });
          y = addText(suggestionClean, margin + 5, y);
          
          y += lineHeight * 1.5; 
        });

        // --- 5. Save the PDF ---
        doc.save(`Insmot_AI_Report_${user.name.replace(' ', '_') || 'Guest'}.pdf`);
      } catch (error) {
        console.error("Error generating PDF:", error);
      }
    };
    
    // ---------------------------------------------
    // Reset Button
    // ---------------------------------------------
    $('restartBtn').onclick = () => {
        // Clear state
        current = 0;
        responses = [];
        breakdown = [];
        // user object is kept by default, but we could clear it
        // user = {}; 
        // localStorage.removeItem('insmotUser');
        
        // Reset inputs on form page (in case user isn't cleared)
        $('jobDescInput').value = '';
        
        // Navigate back to form page
        showPage('formPage');
    }
    
    // --- NEW: Initial Page Load ---
    window.onload = () => {
      loadUserFromLocal(); // Load saved user data
      showPage('formPage'); // Show the first page
    }

  </script>
</body>

</html>
